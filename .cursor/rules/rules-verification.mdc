# ğŸ” VERIFICACIÃ“N DE REGLAS ACTUALIZADAS - PROYECTO COOMUNITY

# ===============================================================================
# SCRIPT DE VALIDACIÃ“N COMPLETA POST-MIGRACIÃ“N DE PUERTOS
# Este archivo verifica que todas las reglas actualizadas se cumplan correctamente
# ===============================================================================

## ğŸ¯ **OBJETIVO**

Verificar que el proyecto CoomÃœnity cumple con todas las reglas actualizadas despuÃ©s de la migraciÃ³n de puertos, previniendo errores comunes y asegurando la estabilidad del ecosistema.

---

## ğŸ§ª **SCRIPT DE VERIFICACIÃ“N INTEGRAL**

```bash
#!/bin/bash

# ğŸ” SCRIPT DE VERIFICACIÃ“N COMPLETA DE REGLAS COOMUNITY
# VersiÃ³n: Post-MigraciÃ³n de Puertos - Enero 2025

echo "ğŸ” INICIANDO VERIFICACIÃ“N COMPLETA DE REGLAS..."
echo "==============================================="
echo ""

# Colors para output
GREEN='ğŸŸ¢'
RED='ğŸ”´'
YELLOW='ğŸŸ¡'
BLUE='ğŸ”µ'

# Contadores
PASSED=0
FAILED=0
WARNINGS=0

# FunciÃ³n para verificaciÃ³n con resultado
check_rule() {
    local test_name="$1"
    local test_command="$2"
    local expected_result="$3"
    
    echo -n "ğŸ“‹ $test_name... "
    
    if eval "$test_command" >/dev/null 2>&1; then
        if [ "$expected_result" = "pass" ]; then
            echo "$GREEN CORRECTO"
            ((PASSED++))
            return 0
        else
            echo "$RED INCORRECTO"
            ((FAILED++))
            return 1
        fi
    else
        if [ "$expected_result" = "fail" ]; then
            echo "$GREEN CORRECTO (esperado)"
            ((PASSED++))
            return 0
        else
            echo "$RED FALLO"
            ((FAILED++))
            return 1
        fi
    fi
}

check_warning() {
    local test_name="$1"
    local test_command="$2"
    local warning_message="$3"
    
    echo -n "âš ï¸  $test_name... "
    
    if eval "$test_command" >/dev/null 2>&1; then
        echo "$GREEN OK"
        ((PASSED++))
    else
        echo "$YELLOW ADVERTENCIA"
        echo "   $warning_message"
        ((WARNINGS++))
    fi
}

echo "ğŸ¯ SECCIÃ“N 1: VERIFICACIÃ“N DE PUERTOS ACTUALIZADOS"
echo "================================================="

# 1.1 Verificar configuraciÃ³n de puertos
check_rule "Backend puerto 1111 en .env" 'grep -q "localhost:1111" .env' "pass"
check_rule "SuperApp puerto 2222 en config" 'grep -q "localhost:2222" Demo/apps/superapp-unified/.env' "pass"
check_rule "Admin puerto 3333 en config" 'grep -q "localhost:3333" apps/admin-frontend/.env' "pass"

# 1.2 Verificar ausencia de puertos obsoletos
check_rule "Sin referencias a puerto 3002" 'grep -r "localhost:3002" . --exclude-dir=node_modules --exclude-dir=.git' "fail"
check_rule "Sin referencias a puerto 3001" 'grep -r "localhost:3001" . --exclude-dir=node_modules --exclude-dir=.git' "fail"
check_rule "Sin referencias a puerto 3000" 'grep -r "localhost:3000" . --exclude-dir=node_modules --exclude-dir=.git' "fail"

echo ""
echo "ğŸ—„ï¸ SECCIÃ“N 2: VERIFICACIÃ“N DE POSTGRESQL"
echo "========================================"

# 2.1 PostgreSQL debe estar disponible
check_warning "PostgreSQL ejecutÃ¡ndose" 'brew services list | grep postgresql | grep started' "PostgreSQL no estÃ¡ iniciado. Ejecuta: brew services start postgresql@15"
check_warning "Puerto 5432 disponible" 'lsof -i :5432 | grep LISTEN' "PostgreSQL no estÃ¡ escuchando en puerto 5432"

echo ""
echo "ğŸ“ SECCIÃ“N 3: VERIFICACIÃ“N DE ESTRUCTURA DE ARCHIVOS"
echo "==================================================="

# 3.1 Archivos crÃ­ticos deben existir
check_rule "Archivo .env principal existe" '[ -f ".env" ]' "pass"
check_rule "Archivo SuperApp .env existe" '[ -f "Demo/apps/superapp-unified/.env" ]' "pass"
check_rule "Archivo Admin .env existe" '[ -f "apps/admin-frontend/.env" ]' "pass"
check_rule "package.json raÃ­z existe" '[ -f "package.json" ]' "pass"
check_rule "turbo.json existe" '[ -f "turbo.json" ]' "pass"

# 3.2 Directorios crÃ­ticos deben existir
check_rule "Directorio SuperApp existe" '[ -d "Demo/apps/superapp-unified" ]' "pass"
check_rule "Directorio Admin existe" '[ -d "apps/admin-frontend" ]' "pass"
check_rule "Directorio Backend existe" '[ -d "src" ]' "pass"

echo ""
echo "ğŸ”§ SECCIÃ“N 4: VERIFICACIÃ“N DE DEPENDENCIAS"
echo "=========================================="

# 4.1 Turborepo local
check_warning "Turborepo instalado localmente" 'npm ls turbo | grep turbo@' "Recomendado instalar Turborepo localmente: npm install turbo --save-dev --legacy-peer-deps"

# 4.2 Dependencias crÃ­ticas SuperApp
cd Demo/apps/superapp-unified/ 2>/dev/null || true
check_warning "Playwright instalado" 'npm ls @playwright/test' "Falta @playwright/test en SuperApp"
check_warning "Sentry instalado" 'npm ls @sentry/react' "Falta @sentry/react en SuperApp"
check_warning "Web Vitals instalado" 'npm ls web-vitals' "Falta web-vitals en SuperApp"
cd ../../.. 2>/dev/null || true

echo ""
echo "âš™ï¸ SECCIÃ“N 5: VERIFICACIÃ“N DE CONFIGURACIONES"
echo "============================================"

# 5.1 Vite configs actualizados
check_rule "SuperApp Vite config puerto 2222" 'grep -q "port: 2222" Demo/apps/superapp-unified/vite.config.ts' "pass"
check_rule "Admin Vite config puerto 3333" 'grep -q "port: 3333" apps/admin-frontend/vite.config.ts' "pass"

# 5.2 CORS config actualizada
check_rule "Backend CORS incluye puerto 1111" 'grep -q "localhost:1111" src/main.ts' "pass"
check_rule "Backend CORS incluye puerto 2222" 'grep -q "localhost:2222" src/main.ts' "pass"
check_rule "Backend CORS incluye puerto 3333" 'grep -q "localhost:3333" src/main.ts' "pass"

echo ""
echo "ğŸ® SECCIÃ“N 6: VERIFICACIÃ“N DE SCRIPTS"
echo "===================================="

# 6.1 Scripts de puerto deben existir
check_rule "Script port:verify existe" 'grep -q "port:verify" package.json' "pass"
check_rule "Script port:summary existe" 'grep -q "port:summary" package.json' "pass"
check_rule "Script dev existe" 'grep -q "\"dev\":" package.json' "pass"

# 6.2 Scripts de verificaciÃ³n ejecutables
check_rule "Script verify-new-ports.sh ejecutable" '[ -x "scripts/verify-new-ports.sh" ]' "pass"
check_rule "Script post-migration-summary.sh ejecutable" '[ -x "scripts/post-migration-summary.sh" ]' "pass"

echo ""
echo "ğŸŒ SECCIÃ“N 7: VERIFICACIÃ“N DE SERVICIOS (OPCIONAL)"
echo "================================================="

# 7.1 Servicios respondiendo (solo si estÃ¡n ejecutÃ¡ndose)
check_warning "Backend responde en puerto 1111" 'curl -s http://localhost:1111/health' "Backend no estÃ¡ ejecutÃ¡ndose (opcional para verificaciÃ³n)"
check_warning "SuperApp responde en puerto 2222" 'curl -s -I http://localhost:2222' "SuperApp no estÃ¡ ejecutÃ¡ndose (opcional para verificaciÃ³n)"
check_warning "Admin responde en puerto 3333" 'curl -s -I http://localhost:3333' "Admin no estÃ¡ ejecutÃ¡ndose (opcional para verificaciÃ³n)"

echo ""
echo "ğŸ“Š SECCIÃ“N 8: VERIFICACIÃ“N DE PROCESOS"
echo "====================================="

# 8.1 No debe haber procesos conflictivos
RUNNING_VITE=$(ps aux | grep -E "vite.*node" | grep -v grep | wc -l)
RUNNING_NPM_DEV=$(ps aux | grep "npm run dev" | grep -v grep | wc -l)

if [ $RUNNING_VITE -gt 1 ]; then
    echo "$RED MÃºltiples procesos Vite detectados ($RUNNING_VITE)"
    echo "   Ejecuta: pkill -f vite"
    ((FAILED++))
else
    echo "$GREEN Procesos Vite normales"
    ((PASSED++))
fi

if [ $RUNNING_NPM_DEV -gt 1 ]; then
    echo "$RED MÃºltiples procesos npm run dev detectados ($RUNNING_NPM_DEV)"
    echo "   Ejecuta: pkill -f 'npm run dev'"
    ((FAILED++))
else
    echo "$GREEN Procesos npm run dev normales"
    ((PASSED++))
fi

# 8.2 Puertos no deben estar ocupados por procesos obsoletos
OCCUPIED_1111=$(lsof -i :1111 2>/dev/null | wc -l)
OCCUPIED_2222=$(lsof -i :2222 2>/dev/null | wc -l)
OCCUPIED_3333=$(lsof -i :3333 2>/dev/null | wc -l)

echo "ğŸ“¡ Puertos ocupados: 1111($OCCUPIED_1111) 2222($OCCUPIED_2222) 3333($OCCUPIED_3333)"

echo ""
echo "ğŸ” SECCIÃ“N 9: VERIFICACIÃ“N DE REGLAS CRÃTICAS"
echo "============================================"

# 9.1 UbicaciÃ³n correcta
CURRENT_DIR=$(pwd)
if [[ "$CURRENT_DIR" == *"/workspace"* ]] || [[ "$CURRENT_DIR" == *"GAMIFIER"* ]]; then
    echo "$GREEN UbicaciÃ³n de workspace correcta"
    ((PASSED++))
else
    echo "$RED UbicaciÃ³n incorrecta: $CURRENT_DIR"
    echo "   Debe estar en la raÃ­z del monorepo"
    ((FAILED++))
fi

# 9.2 Variables de entorno crÃ­ticas
ENV_VARS_OK=true

if ! grep -q "VITE_API_BASE_URL=http://localhost:1111" .env 2>/dev/null; then
    echo "$RED Variable VITE_API_BASE_URL incorrecta en .env"
    ENV_VARS_OK=false
fi

if ! grep -q "VITE_BASE_URL=http://localhost:2222" Demo/apps/superapp-unified/.env 2>/dev/null; then
    echo "$RED Variable VITE_BASE_URL incorrecta en SuperApp .env"
    ENV_VARS_OK=false
fi

if $ENV_VARS_OK; then
    echo "$GREEN Variables de entorno crÃ­ticas correctas"
    ((PASSED++))
else
    ((FAILED++))
fi

echo ""
echo "ğŸŠ RESUMEN FINAL"
echo "==============="
echo "âœ… PASSED: $PASSED"
echo "âŒ FAILED: $FAILED"
echo "âš ï¸  WARNINGS: $WARNINGS"
echo ""

# Calcular porcentaje de Ã©xito
TOTAL=$((PASSED + FAILED))
if [ $TOTAL -gt 0 ]; then
    SUCCESS_RATE=$((PASSED * 100 / TOTAL))
    echo "ğŸ“Š TASA DE Ã‰XITO: $SUCCESS_RATE%"
else
    echo "ğŸ“Š TASA DE Ã‰XITO: 0%"
fi

echo ""

if [ $FAILED -eq 0 ]; then
    echo "ğŸ‰ Â¡TODAS LAS REGLAS CRÃTICAS SE CUMPLEN!"
    echo "ğŸš€ El proyecto estÃ¡ listo para desarrollo"
elif [ $FAILED -le 3 ]; then
    echo "âš ï¸  ADVERTENCIAS MENORES DETECTADAS"
    echo "ğŸ”§ Revisa y corrige los errores indicados"
elif [ $FAILED -le 6 ]; then
    echo "âŒ ERRORES MODERADOS DETECTADOS"
    echo "ğŸ› ï¸  Se requiere correcciÃ³n antes de continuar"
else
    echo "ğŸš¨ ERRORES CRÃTICOS DETECTADOS"
    echo "ğŸ†˜ Se requiere correcciÃ³n inmediata"
fi

echo ""
echo "ğŸ“‹ COMANDOS DE CORRECCIÃ“N RÃPIDA:"
echo "================================"
echo "ğŸ”§ Limpiar procesos: pkill -f 'vite|npm run dev'"
echo "ğŸ—„ï¸ Iniciar PostgreSQL: brew services start postgresql@15"
echo "ğŸ“¦ Instalar deps faltantes: npm install turbo @sentry/react web-vitals --legacy-peer-deps"
echo "ğŸŒ Verificar servicios: npm run port:verify"
echo "ğŸ“Š Ver resumen: npm run port:summary"

exit $FAILED
```

---

## ğŸ“‹ **CHECKLIST DE REGLAS ACTUALIZADAS**

### **âœ… REGLAS DE PUERTOS (CRÃTICAS)**
- [ ] Backend configurado para puerto 1111
- [ ] SuperApp configurado para puerto 2222  
- [ ] Admin configurado para puerto 3333
- [ ] Sin referencias a puertos obsoletos (3002, 3001, 3000)
- [ ] CORS actualizado con nuevos puertos
- [ ] Playwright config actualizado

### **âœ… REGLAS DE ENTORNO**
- [ ] PostgreSQL ejecutÃ¡ndose en puerto 5432
- [ ] Variables .env actualizadas con nuevos puertos
- [ ] Archivos .env existen en todas las ubicaciones
- [ ] Sin hardcoding de puertos obsoletos

### **âœ… REGLAS DE DEPENDENCIAS**
- [ ] Turborepo instalado localmente
- [ ] @playwright/test instalado solo en SuperApp
- [ ] @sentry/react instalado en SuperApp
- [ ] web-vitals instalado en SuperApp
- [ ] Material UI v7 con --legacy-peer-deps

### **âœ… REGLAS DE PROCESOS**
- [ ] Sin mÃºltiples procesos Vite simultÃ¡neos
- [ ] Sin mÃºltiples procesos npm run dev
- [ ] Puertos libres antes de iniciar servicios
- [ ] Limpieza de procesos anterior a desarrollo

### **âœ… REGLAS DE SCRIPTS**
- [ ] Scripts port:verify y port:summary disponibles
- [ ] Scripts de verificaciÃ³n ejecutables
- [ ] Comandos de desarrollo actualizados
- [ ] Pre-flight check actualizado

---

## ğŸš€ **COMANDOS DE EJECUCIÃ“N**

### **VerificaciÃ³n RÃ¡pida:**
```bash
# Ejecutar script de verificaciÃ³n
chmod +x .cursor/rules/rules-verification.sh
./.cursor/rules/rules-verification.sh
```

### **VerificaciÃ³n Individual:**
```bash
# Solo puertos
npm run port:verify

# Solo configuraciÃ³n
npm run port:summary

# Solo dependencias
npm ls turbo @playwright/test @sentry/react web-vitals
```

### **CorrecciÃ³n AutomÃ¡tica:**
```bash
# Limpiar y reiniciar
pkill -f "vite|npm run dev" && npm run dev

# Instalar dependencias faltantes
npm install turbo @sentry/react web-vitals --legacy-peer-deps

# Verificar PostgreSQL
brew services start postgresql@15
```

---

## ğŸ¯ **CRITERIOS DE ACEPTACIÃ“N**

### **ğŸŸ¢ ESTADO Ã“PTIMO (Objetivo)**
- âœ… 95%+ de reglas cumplidas
- âœ… 0 errores crÃ­ticos
- âœ… MÃ¡ximo 2 advertencias menores

### **ğŸŸ¡ ESTADO ACEPTABLE**
- âœ… 85%+ de reglas cumplidas  
- âœ… MÃ¡ximo 3 errores menores
- âœ… Servicios principales funcionando

### **ğŸ”´ ESTADO CRÃTICO (Requiere CorrecciÃ³n)**
- âŒ Menos de 85% de reglas cumplidas
- âŒ Errores en puertos o PostgreSQL
- âŒ Dependencias crÃ­ticas faltantes

---

## ğŸ“ **REGISTRO DE CAMBIOS**

### **VersiÃ³n Post-MigraciÃ³n - Enero 2025**
- âœ… Reglas de puertos actualizadas (1111, 2222, 3333)
- âœ… VerificaciÃ³n de puertos obsoletos
- âœ… Scripts de migraciÃ³n incluidos
- âœ… Checklist de dependencias actualizado
- âœ… Protocolo de correcciÃ³n automatizado

**ğŸŠ Las reglas estÃ¡n actualizadas y listas para mantener la estabilidad del proyecto CoomÃœnity post-migraciÃ³n.**