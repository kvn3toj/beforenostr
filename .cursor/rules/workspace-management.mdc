---
description: 
globs: 
alwaysApply: true
---
# ğŸ—ï¸ REGLAS CRÃTICAS DE GESTIÃ“N DE WORKSPACE - PROYECTO COOMUNITY

# ===============================================================================
# REGLAS BASADAS EN APRENDIZAJES COSTOSOS Y EXPERIENCIAS REALES
# Estas reglas previenen errores que han causado reprocesos significativos
# ===============================================================================

## ğŸš¨ **REGLA DE ORO FUNDAMENTAL - CRÃTICA**

### **"TODOS LOS COMANDOS DESDE LA RAÃZ DEL MONOREPO"**

**UBICACIÃ“N DE LA RAÃZ:** `/Users/kevinp/Movies/GAMIFIER copy/`

**REGLA OBLIGATORIA:**
```bash
# âœ… CORRECTO - SIEMPRE desde la raÃ­z
pwd  # Debe mostrar: /Users/kevinp/Movies/GAMIFIER copy
npm run dev
npm run test:e2e --workspace=Demo/apps/superapp-unified

# âŒ PROHIBIDO - NUNCA desde subdirectorios
cd Demo/apps/superapp-unified/ && npm run dev  # âŒ CAUSA ERRORES
cd backend/ && npm run dev                      # âŒ CAUSA ERRORES
```

**RAZÃ“N CRÃTICA:** Ejecutar comandos desde subdirectorios causa:
- Errores de contexto e importaciones rotas
- Configuraciones incorrectas 
- Fallos fantasma en tests
- PÃ©rdida de orquestaciÃ³n del monorepo

---

## ğŸ”„ **GESTIÃ“N DE PROCESOS MÃšLTIPLES - CRÃTICA**

### **PROBLEMA IDENTIFICADO:**
MÃºltiples procesos `npm run dev` y `vite` ejecutÃ¡ndose simultÃ¡neamente causan:
- Conflictos de puerto
- Errores de compilaciÃ³n
- Comportamiento impredecible
- Consumo excesivo de recursos

### **PROTOCOLO DE LIMPIEZA OBLIGATORIO:**

**Antes de CUALQUIER comando de desarrollo:**
```bash
# 1. DETECTAR PROCESOS MÃšLTIPLES
ps aux | grep -E "(vite|npm run dev)" | grep -v grep

# 2. LIMPIAR PROCESOS CONFLICTIVOS
pkill -f "vite" 2>/dev/null || true
pkill -f "npm run dev" 2>/dev/null || true

# 3. LIMPIAR PUERTOS OCUPADOS
lsof -ti:3000,3001,3002,3003,5173 | xargs kill -9 2>/dev/null || true

# 4. VERIFICAR LIMPIEZA
lsof -i :3001 || echo "Puerto 3001 libre âœ…"
lsof -i :3002 || echo "Puerto 3002 libre âœ…"

# 5. INICIAR SERVICIOS LIMPIOS
npm run dev  # Desde la raÃ­z
```

**REGLA DE UN SOLO PROCESO:** NUNCA ejecutar mÃºltiples instancias de `npm run dev` simultÃ¡neamente.

---

## ğŸ›ï¸ **SEPARACIÃ“N ARQUITECTÃ“NICA CRÃTICA**

### **APRENDIZAJE COSTOSO RESUELTO:**
**PROBLEMA:** 151 archivos React (.tsx/.jsx) estaban mezclados en `./src/` del backend NestJS
**SÃNTOMA:** Error "Failed to resolve import ../pages/AnalyticsPage"
**SOLUCIÃ“N:** Archivos movidos a `./_temp_frontend_src_files/` para aislarlos

### **REGLAS DE SEPARACIÃ“N ESTRICTA:**

**Directorios Backend:**
```bash
./src/                    # SOLO archivos NestJS (controllers, services, modules)
./prisma/                 # SOLO esquemas y migraciones de base de datos
./dist/                   # SOLO builds del backend compilado
```

**Directorios Frontend:**
```bash
Demo/apps/superapp-unified/src/    # SOLO archivos React de SuperApp
admin-frontend/src/                # SOLO archivos React de Admin
```

**PROHIBIDO ABSOLUTAMENTE:**
- Archivos `.tsx/.jsx` en directorios del backend
- Archivos de backend en directorios de frontend
- Importaciones cruzadas entre backend y frontend
- Dependencias compartidas sin workspace especÃ­fico

---

## ğŸ“‚ **ORGANIZACIÃ“N DE DIRECTORIO RAÃZ**

### **REORGANIZACIÃ“N MASIVA COMPLETADA:**
- **ANTES:** 483 archivos en directorio raÃ­z (caos total)
- **DESPUÃ‰S:** 27 archivos en directorio raÃ­z (94% reducciÃ³n)

### **ESTRUCTURA ORGANIZADA OBLIGATORIA:**

**Directorio RaÃ­z (SOLO archivos esenciales):**
```bash
/Users/kevinp/Movies/GAMIFIER copy/
â”œâ”€â”€ package.json          # Orquestador principal
â”œâ”€â”€ turbo.json           # ConfiguraciÃ³n Turborepo
â”œâ”€â”€ .env                 # Variables globales
â”œâ”€â”€ tsconfig.json        # ConfiguraciÃ³n TypeScript global
â”œâ”€â”€ .gitignore          # Exclusiones Git
â””â”€â”€ README.md           # DocumentaciÃ³n principal
```

**Directorios Organizacionales:**
```bash
logs/                    # 31 archivos organizados (auth/, backend/, testing/)
config/                  # 16 archivos de configuraciÃ³n (json/, backup/)
docs/diagrams/           # 6 archivos de diagramas (.mmd)
scripts/database/        # 7 archivos SQL y scripts de DB
```

**REGLA DE MANTENIMIENTO:** El directorio raÃ­z NUNCA debe exceder 30 archivos.

---

## ğŸ¯ **PROTOCOLO PRE-FLIGHT CHECK EXPANDIDO**

### **VERIFICACIÃ“N OBLIGATORIA antes de cualquier tarea:**

```bash
#!/bin/bash
echo "ğŸ” INICIANDO PRE-FLIGHT CHECK CRÃTICO..."

# 1. VERIFICAR UBICACIÃ“N CORRECTA
CURRENT_DIR=$(pwd)
EXPECTED_DIR="/Users/kevinp/Movies/GAMIFIER copy"
if [ "$CURRENT_DIR" != "$EXPECTED_DIR" ]; then
  echo "âŒ ERROR: UbicaciÃ³n incorrecta"
  echo "ğŸ“ Actual: $CURRENT_DIR"
  echo "ğŸ“ Esperada: $EXPECTED_DIR"
  echo "ğŸ”§ Ejecuta: cd '$EXPECTED_DIR'"
  exit 1
fi
echo "âœ… UbicaciÃ³n correcta verificada"

# 2. LIMPIAR PROCESOS MÃšLTIPLES
echo "ğŸ§¹ Limpiando procesos mÃºltiples..."
pkill -f "vite" 2>/dev/null || true
pkill -f "npm run dev" 2>/dev/null || true
pkill -f "turbo" 2>/dev/null || true
sleep 2

# 3. VERIFICAR LIMPIEZA DE PROCESOS
RUNNING_PROCESSES=$(ps aux | grep -E "(vite|npm run dev)" | grep -v grep | wc -l)
if [ $RUNNING_PROCESSES -gt 0 ]; then
  echo "âš ï¸ ADVERTENCIA: Procesos aÃºn ejecutÃ¡ndose:"
  ps aux | grep -E "(vite|npm run dev)" | grep -v grep
fi

# 4. LIMPIAR PUERTOS OCUPADOS
echo "ğŸ”§ Liberando puertos ocupados..."
lsof -ti:3000,3001,3002,3003,5173 | xargs kill -9 2>/dev/null || true

# 5. VERIFICAR CONFIGURACIÃ“N DE PUERTOS
echo "ğŸ“‹ Verificando configuraciÃ³n de puertos..."
if [ -f "Demo/apps/superapp-unified/.env" ]; then
  SUPERAPP_PORT=$(grep VITE_BASE_URL Demo/apps/superapp-unified/.env | cut -d':' -f3 | cut -d'/' -f1)
  if [ "$SUPERAPP_PORT" != "3001" ]; then
    echo "âš ï¸ ADVERTENCIA: Puerto SuperApp no es 3001 (actual: $SUPERAPP_PORT)"
  fi
fi

# 6. ğŸ†• VERIFICAR TURBOREPO LOCAL
echo "ğŸ”§ Verificando Turborepo local..."
TURBO_LOCAL=$(npm ls turbo 2>/dev/null | grep turbo@ | cut -d@ -f2)
if [ -z "$TURBO_LOCAL" ]; then
  echo "âš ï¸ RECOMENDADO: Instalar Turborepo localmente"
  echo "ğŸ”§ Ejecuta: npm install turbo --save-dev --legacy-peer-deps"
else
  echo "âœ… Turborepo local: v$TURBO_LOCAL"
fi

# 7. VERIFICAR DEPENDENCIAS CRÃTICAS
echo "ğŸ“¦ Verificando dependencias crÃ­ticas..."
cd Demo/apps/superapp-unified/
npm ls @sentry/react >/dev/null 2>&1 || echo "âš ï¸ FALTA: @sentry/react"
npm ls web-vitals >/dev/null 2>&1 || echo "âš ï¸ FALTA: web-vitals"
npm ls @playwright/test >/dev/null 2>&1 || echo "âš ï¸ FALTA: @playwright/test"
cd ../../../

# 8. VERIFICAR SERVICIOS (si estÃ¡n ejecutÃ¡ndose)
echo "ğŸŒ Verificando servicios disponibles..."
curl -s http://localhost:3002/health >/dev/null && echo "âœ… Backend (3002) disponible" || echo "âš ï¸ Backend (3002) no disponible"
curl -s -I http://localhost:3001 >/dev/null && echo "âœ… SuperApp (3001) disponible" || echo "â„¹ï¸ SuperApp (3001) no iniciada"

echo "ğŸ PRE-FLIGHT CHECK COMPLETADO"
echo "â–¶ï¸ Listo para ejecutar: turbo run dev"
```

---

## ğŸ® **COMANDOS CANÃ“NICOS DEFINITIVOS**

### **Comandos de Desarrollo (desde la raÃ­z ÃšNICAMENTE):**

```bash
# ğŸš€ INICIAR ECOSISTEMA COMPLETO (Comando Principal) âœ… VERIFICADO
turbo run dev
# o alternativamente:
npm run dev

# ğŸ¯ WORKSPACE ESPECÃFICO âœ… VERIFICADO
npm run dev:backend              # Backend NestJS (puerto 3002)
npm run dev:superapp             # SuperApp (puerto 3001)

# ğŸ” FILTROS TURBOREPO âœ… FUNCIONAL
turbo run dev --filter=...backend*
turbo run dev --filter=...superapp*

# ğŸ“Š TESTS ESPECÃFICOS
npm run test:e2e --workspace=coomunity-superapp
```

### **Comandos de VerificaciÃ³n âœ… PROBADOS:**

```bash
# ğŸ“ VERIFICAR UBICACIÃ“N
pwd  # Debe mostrar: /Users/kevinp/Movies/GAMIFIER copy

# ğŸ” DETECTAR PROCESOS MÃšLTIPLES
ps aux | grep -E "(vite|npm)" | grep -v grep

# ğŸŒ VERIFICAR SERVICIOS âœ… CONFIRMADOS
curl http://localhost:3002/health  # Backend: {"status":"ok","message":"Backend is running"}
curl http://localhost:3001 -I      # SuperApp: HTTP/1.1 200 OK

# ğŸ“‹ VERIFICAR CONFIGURACIÃ“N
cat Demo/apps/superapp-unified/.env | grep VITE_BASE_URL
```

### **ğŸ†• CONFIGURACIÃ“N TURBOREPO EXITOSA:**

**package.json raÃ­z (OBLIGATORIO):**
```json
{
  "packageManager": "npm@10.0.0",
  "workspaces": [
    "Demo/apps/*",
    "apps/*", 
    "packages/*"
  ],
  "scripts": {
    "dev": "turbo run dev",
    "dev:backend": "npm run start:backend:dev",
    "dev:superapp": "npm run dev --workspace=coomunity-superapp"
  }
}
```

**turbo.json (OBLIGATORIO):**
```json
{
  "$schema": "https://turbo.build/schema.json",
  "tasks": {
    "dev": {
      "cache": false,
      "persistent": true
    }
  }
}
```

---

## ğŸš¨ **ERRORES CRÃTICOS A EVITAR ABSOLUTAMENTE**

### **âŒ PROHIBIDO:**

1. **Comandos desde subdirectorios:**
   ```bash
   # âŒ NUNCA HACER ESTO:
   cd Demo/apps/superapp-unified/ && npm run dev
   cd backend/ && npm run dev
   ```

2. **MÃºltiples procesos simultÃ¡neos:**
   ```bash
   # âŒ NUNCA ejecutar mÃºltiples instancias
   npm run dev  # Ya ejecutÃ¡ndose
   npm run dev  # âŒ Segunda instancia causa conflictos
   ```

3. **Mezclar archivos backend/frontend:**
   ```bash
   # âŒ NUNCA poner archivos React en:
   ./src/components/          # âŒ Es directorio de backend
   ./src/pages/              # âŒ Es directorio de backend
   ```

4. **Ignorar limpieza de procesos:**
   ```bash
   # âŒ NUNCA iniciar sin limpiar:
   npm run dev  # Sin pkill previo causa conflictos
   ```

5. **ğŸ†• Usar solo Turborepo global:**
   ```bash
   # âŒ EVITAR: Solo instalaciÃ³n global (causa advertencias)
   # WARNING: No locally installed `turbo` found
   ```

### **âœ… OBLIGATORIO:**

1. **Siempre verificar ubicaciÃ³n:**
   ```bash
   pwd  # Verificar raÃ­z antes de comandos
   ```

2. **Siempre limpiar procesos:**
   ```bash
   pkill -f "vite" && pkill -f "npm run dev" && pkill -f "turbo"
   ```

3. **ğŸ†• Instalar Turborepo localmente:**
   ```bash
   npm install turbo --save-dev --legacy-peer-deps
   npm ls turbo  # Verificar instalaciÃ³n local
   ```

4. **Siempre usar workspace sintaxis:**
   ```bash
   npm run <script> --workspace=<nombre_del_paquete>
   ```

5. **Siempre mantener separaciÃ³n arquitectÃ³nica:**
   ```bash
   # Backend: ./src/ - SOLO NestJS
   # Frontend: Demo/apps/superapp-unified/src/ - SOLO React
   ```

---

## ğŸ“ˆ **BENEFICIOS COMPROBADOS**

### **Implementando estas reglas se logrÃ³:**

- âœ… **Tests E2E al 100%** (3/3 exitosos)
- âœ… **EliminaciÃ³n completa de errores de importaciÃ³n**
- âœ… **Arquitectura limpia y mantenible**
- âœ… **Desarrollo sin conflictos de puerto**
- âœ… **ReducciÃ³n 94% de archivos en directorio raÃ­z**
- âœ… **OrquestaciÃ³n eficiente con Turborepo** â­ **CONFIRMADO ENERO 2025**
- âœ… **SeparaciÃ³n estricta backend/frontend**
- âœ… **Backend NestJS operacional** (puerto 3002, health check exitoso)
- âœ… **SuperApp funcional** (puerto 3001, HTTP/1.1 200 OK)
- âœ… **Base de datos Prisma conectada** (todas las rutas mapeadas)
- âœ… **ConfiguraciÃ³n Turborepo corregida** (tasks, packageManager, workspaces)

### **Costos evitados:**
- ğŸš« Reprocesos por errores de contexto
- ğŸš« Debugging de importaciones rotas
- ğŸš« Conflictos de puerto y procesos
- ğŸš« ConfusiÃ³n arquitectÃ³nica
- ğŸš« PÃ©rdida de tiempo en configuraciÃ³n

---

## ğŸ¯ **RESUMEN EJECUTIVO**

### **REGLA FUNDAMENTAL:**
> **"El directorio raÃ­z del monorepo es el centro de comando. Todo se ejecuta desde ahÃ­, todo se organiza desde ahÃ­, y todo se controla desde ahÃ­."**

### **PROTOCOLO OBLIGATORIO:**
1. **Verificar ubicaciÃ³n** (`pwd`)
2. **Limpiar procesos** (`pkill -f "vite" && pkill -f "turbo"`)
3. **Verificar puertos** (`lsof -i :3001`)
4. **Ejecutar desde raÃ­z** (`turbo run dev`)
5. **Usar workspace sintaxis** (`--workspace=<name>`)

### **PROHIBICIONES ABSOLUTAS:**
- âŒ Comandos desde subdirectorios
- âŒ MÃºltiples procesos simultÃ¡neos
- âŒ Mezclar archivos backend/frontend
- âŒ MÃ¡s de 30 archivos en directorio raÃ­z
- âŒ Ignorar limpieza de procesos

**Estas reglas son el resultado de aprendizajes costosos y DEBEN seguirse para mantener la estabilidad y eficiencia del proyecto CoomÃœnity.**

---

## ğŸ‰ **CONFIGURACIÃ“N EXITOSA - JUNIO 2025**

### **âœ… ESTADO CONFIRMADO:**

- **Turborepo**: Funcionando correctamente con configuraciÃ³n corregida
- **Backend NestJS**: Operacional en puerto 3002 (health check exitoso)
- **SuperApp**: Operacional en puerto 3001 (HTTP/1.1 200 OK)
- **Base de datos**: Prisma conectada, todas las rutas mapeadas
- **ConfiguraciÃ³n**: package.json y turbo.json corregidos y funcionales

### **ğŸš€ COMANDOS PRINCIPALES VERIFICADOS:**

```bash
# Comando principal (desde la raÃ­z)
turbo run dev                    # âœ… FUNCIONAL

# Servicios individuales
npm run dev:backend              # âœ… FUNCIONAL (puerto 3002)
npm run dev:superapp            # âœ… FUNCIONAL (puerto 3001)

# VerificaciÃ³n de servicios
curl http://localhost:3002/health # âœ… RESPONDE
curl http://localhost:3001 -I    # âœ… RESPONDE
```

### **ğŸ“‹ CONFIGURACIÃ“N CLAVE EXITOSA:**

- **packageManager**: "npm@10.0.0" âœ…
- **workspaces**: ["Demo/apps/*", "apps/*", "packages/*"] âœ…
- **turbo.json**: "tasks" en lugar de "pipeline" âœ…
- **Scripts de orquestaciÃ³n**: Configurados y funcionales âœ…
- **Turborepo local**: v2.5.4 instalado localmente âœ… (eliminÃ³ advertencias)

### **ğŸ”§ INSTALACIÃ“N TURBOREPO LOCAL RECOMENDADA:**

```bash
# Instalar Turborepo localmente para eliminar advertencias
npm install turbo --save-dev --legacy-peer-deps

# Verificar instalaciÃ³n local
npm ls turbo  # Debe mostrar: turbo@2.5.4

# Verificar que no hay advertencias
turbo --version  # Debe mostrar solo: 2.5.4 (sin warnings)
```

**Beneficios de la instalaciÃ³n local:**
- âœ… **Sin advertencias** sobre versiÃ³n global
- âœ… **Consistencia** entre desarrolladores del equipo
- âœ… **Caching optimizado** especÃ­fico del proyecto
- âœ… **CI/CD determinÃ­stico** con versiÃ³n fija
- âœ… **ConfiguraciÃ³n robusta** para producciÃ³n
