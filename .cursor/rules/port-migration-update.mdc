# ğŸš€ REGLAS ACTUALIZADAS POST-MIGRACIÃ“N DE PUERTOS - PROYECTO COOMUNITY

# ===============================================================================
# VERSIÃ“N ACTUALIZADA: ENERO 2025 - POST MIGRACIÃ“N DE PUERTOS
# Estas reglas reflejan los NUEVOS PUERTOS y mejores prÃ¡cticas actualizadas
# ===============================================================================

## ğŸ¯ **PUERTOS DEFINITIVOS ACTUALIZADOS - CRÃTICO**

### **ğŸ”’ REGLA DE BLOQUEO DE PUERTOS**
**Los siguientes puertos son DEFINITIVOS y NO DEBEN CAMBIARSE:**

| ğŸ”§ **Servicio** | ğŸŒ **Puerto** | ğŸ“ **URL** | ğŸ“‹ **Directorio** |
|-----------------|---------------|------------|-------------------|
| **Backend NestJS** | **1111** | http://localhost:1111 | `backend/` |
| **SuperApp Frontend** | **2222** | http://localhost:2222 | `Demo/apps/superapp-unified/` |
| **Gamifier Admin** | **3333** | http://localhost:3333 | `apps/admin-frontend/` |
| **API Docs** | **1111/api** | http://localhost:1111/api | Swagger UI |

### **âŒ PUERTOS OBSOLETOS (NO USAR NUNCA)**
- âŒ Backend: 3002 (OBSOLETO)
- âŒ SuperApp: 3001 (OBSOLETO)  
- âŒ Admin: 3000 (OBSOLETO)

---

## ğŸ›¡ï¸ **REGLAS DE PREVENCIÃ“N DE ERRORES**

### **1. VerificaciÃ³n de Puertos Obligatoria**
Antes de cualquier comando, SIEMPRE verificar:

```bash
# âœ… VERIFICAR PUERTOS CORRECTOS
npm run port:verify

# âœ… VERIFICAR CONFIGURACIÃ“N
cat .env | grep API_BASE_URL
cat Demo/apps/superapp-unified/.env | grep VITE_BASE_URL
```

### **2. Variables de Entorno ACTUALIZADAS**

```bash
# âœ… .env (Backend)
VITE_API_BASE_URL=http://localhost:1111

# âœ… Demo/apps/superapp-unified/.env (SuperApp)
VITE_API_BASE_URL=http://localhost:1111
VITE_BASE_URL=http://localhost:2222

# âœ… apps/admin-frontend/.env (Admin)
VITE_API_BASE_URL=http://localhost:1111
VITE_BASE_URL=http://localhost:3333
```

### **3. Comandos de Health Check ACTUALIZADOS**

```bash
# âœ… CORRECTO - Nuevos puertos
curl http://localhost:1111/health  # Backend
curl http://localhost:2222         # SuperApp
curl http://localhost:3333         # Admin

# âŒ INCORRECTO - Puertos obsoletos
curl http://localhost:3002/health  # NO USAR
curl http://localhost:3001         # NO USAR
curl http://localhost:3000         # NO USAR
```

---

## ğŸ”§ **CONFIGURACIONES CRÃTICAS ACTUALIZADAS**

### **Backend NestJS (Puerto 1111)**

```typescript
// src/main.ts - CONFIGURACIÃ“N CORRECTA
app.enableCors({
  origin: [
    'http://localhost:1111',  // Backend
    'http://localhost:2222',  // SuperApp  
    'http://localhost:3333',  // Admin
    'http://localhost:5173'   // Vite dev fallback
  ],
  methods: 'GET,HEAD,PUT,PATCH,POST,DELETE,OPTIONS',
  credentials: true,
});

const port = process.env.PORT || 1111; // âœ… CORRECTO
```

### **SuperApp Vite Config (Puerto 2222)**

```typescript
// Demo/apps/superapp-unified/vite.config.ts
export default defineConfig({
  server: {
    port: 2222, // âœ… CORRECTO
    proxy: {
      '/api': {
        target: 'http://localhost:1111', // âœ… Backend correcto
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  },
  preview: {
    port: 2222 // âœ… CORRECTO
  }
});
```

### **Gamifier Admin Vite Config (Puerto 3333)**

```typescript
// apps/admin-frontend/vite.config.ts
export default defineConfig({
  server: {
    port: 3333 // âœ… CORRECTO
  },
  preview: {
    port: 3333 // âœ… CORRECTO
  }
});
```

---

## ğŸ§ª **TESTING ACTUALIZADO**

### **Playwright Config ACTUALIZADO**

```typescript
// Demo/apps/superapp-unified/playwright.config.ts
export default defineConfig({
  use: {
    baseURL: 'http://localhost:2222', // âœ… CORRECTO
  },
  webServer: {
    command: 'npm run dev',
    port: 2222, // âœ… CORRECTO
    reuseExistingServer: !process.env.CI,
  }
});
```

### **Test Authentication ACTUALIZADO**

```typescript
// Tests E2E con puertos correctos
const BACKEND_URL = 'http://localhost:1111'; // âœ… CORRECTO
const SUPERAPP_URL = 'http://localhost:2222'; // âœ… CORRECTO

// Login test con backend correcto
const response = await fetch(`${BACKEND_URL}/auth/login`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    email: 'admin@gamifier.com',
    password: 'admin123'
  })
});
```

---

## ğŸš¨ **ERRORES CRÃTICOS A EVITAR**

### **âŒ NUNCA USAR PUERTOS OBSOLETOS**

```bash
# âŒ OBSOLETO - NO USAR
http://localhost:3002  # Backend antiguo
http://localhost:3001  # SuperApp antigua
http://localhost:3000  # Admin antiguo

# âœ… CORRECTO - USAR SIEMPRE
http://localhost:1111  # Backend NUEVO
http://localhost:2222  # SuperApp NUEVA  
http://localhost:3333  # Admin NUEVO
```

### **âŒ NUNCA HARDCODEAR PUERTOS OBSOLETOS**

```typescript
// âŒ INCORRECTO
const API_URL = 'http://localhost:3002'; // Puerto obsoleto

// âœ… CORRECTO
const API_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:1111';
```

### **âŒ NUNCA SKIP VERIFICACIÃ“N DE PUERTOS**

```bash
# âŒ INCORRECTO - Iniciar sin verificar
npm run dev

# âœ… CORRECTO - Siempre verificar primero
npm run port:verify && npm run dev
```

---

## ğŸ“‹ **PROTOCOLO DE DESARROLLO ACTUALIZADO**

### **1. Pre-Flight Check MEJORADO**

```bash
#!/bin/bash
# Protocolo obligatorio antes de cualquier desarrollo

echo "ğŸ” Pre-Flight Check con puertos actualizados..."

# 1. Verificar ubicaciÃ³n correcta
pwd  # Debe mostrar raÃ­z del monorepo

# 2. Limpiar procesos anteriores
pkill -f "vite|npm run dev|tsx" 2>/dev/null || true

# 3. Verificar puertos libres (nuevos puertos)
echo "ğŸ“¡ Verificando puertos libres..."
lsof -i :1111 >/dev/null && echo "âš ï¸  Puerto 1111 ocupado" || echo "âœ… Puerto 1111 libre"
lsof -i :2222 >/dev/null && echo "âš ï¸  Puerto 2222 ocupado" || echo "âœ… Puerto 2222 libre"  
lsof -i :3333 >/dev/null && echo "âš ï¸  Puerto 3333 ocupado" || echo "âœ… Puerto 3333 libre"

# 4. Verificar configuraciÃ³n de entorno
echo "ğŸ“‹ Verificando configuraciÃ³n..."
cat .env | grep "localhost:1111" >/dev/null || echo "âŒ Backend config incorrecta"
cat Demo/apps/superapp-unified/.env | grep "localhost:2222" >/dev/null || echo "âŒ SuperApp config incorrecta"

# 5. Verificar PostgreSQL (dependencia crÃ­tica)
brew services list | grep postgresql | grep started >/dev/null || echo "âŒ PostgreSQL no iniciado"

echo "âœ… Pre-Flight Check completado"
```

### **2. Comandos de Inicio ACTUALIZADOS**

```bash
# âœ… ECOSISTEMA COMPLETO (Recomendado)
npm run dev  # Inicia todo en puertos correctos

# âœ… SERVICIOS INDIVIDUALES (Solo para debug)
npm run dev:backend   # Backend en puerto 1111
npm run dev:superapp  # SuperApp en puerto 2222  
npm run dev:admin     # Admin en puerto 3333

# âœ… VERIFICACIÃ“N POST-INICIO
npm run port:verify   # Confirma que todo funciona
npm run port:summary  # Ver resumen completo
```

### **3. Troubleshooting ACTUALIZADO**

```bash
# ğŸ”§ Si hay problemas de puerto
echo "ğŸš¨ Solucionando problemas de puerto..."

# Matar procesos en puertos nuevos
lsof -ti:1111,2222,3333 | xargs kill -9 2>/dev/null || true

# Verificar que no hay referencias a puertos obsoletos
grep -r "localhost:3002" . --exclude-dir=node_modules || echo "âœ… Sin refs puerto 3002"
grep -r "localhost:3001" . --exclude-dir=node_modules || echo "âœ… Sin refs puerto 3001"  
grep -r "localhost:3000" . --exclude-dir=node_modules || echo "âœ… Sin refs puerto 3000"

# Limpiar cachÃ© si es necesario
rm -rf node_modules/.vite
rm -rf Demo/apps/superapp-unified/node_modules/.vite
rm -rf apps/admin-frontend/node_modules/.vite
```

---

## ğŸ“Š **SCRIPTS ACTUALIZADOS**

### **package.json Scripts MEJORADOS**

```json
{
  "scripts": {
    "dev": "turbo run dev",
    "port:verify": "./scripts/verify-new-ports.sh",
    "port:summary": "./scripts/post-migration-summary.sh", 
    "port:clean": "lsof -ti:1111,2222,3333 | xargs kill -9 2>/dev/null || true",
    "preflight": "./scripts/pre-flight-check.sh && npm run port:verify"
  }
}
```

---

## ğŸ¯ **CREDENCIALES DE DESARROLLO**

### **Backend Auth (Puerto 1111)**
```bash
# Test de autenticaciÃ³n con puerto correcto
curl -X POST "http://localhost:1111/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@gamifier.com", "password": "admin123"}'
```

### **Credenciales Disponibles (Sin cambios)**
- `admin@gamifier.com` / `admin123` (admin)
- `user@gamifier.com` / `123456` (user)
- `creator@gamifier.com` / `123456` (creator)

---

## ğŸ“š **DOCUMENTACIÃ“N ACTUALIZADA**

### **URLs de Referencia NUEVAS**
- ğŸ“‹ **MigraciÃ³n**: `docs/implementation/PORT_MIGRATION_SUMMARY.md`
- ğŸš¨ **Troubleshooting**: `docs/troubleshooting/BACKGROUND_AGENT_ERROR_RESOLUTION.md`
- âœ… **VerificaciÃ³n**: `scripts/verify-new-ports.sh`

### **Links de Acceso ACTUALIZADOS**
- ğŸ”§ **Admin Panel**: http://localhost:3333  
- ğŸ® **SuperApp**: http://localhost:2222
- âš™ï¸ **Backend**: http://localhost:1111
- ğŸ“š **API Docs**: http://localhost:1111/api

---

## ğŸŠ **RESUMEN EJECUTIVO**

### **âœ… ESTADO POST-MIGRACIÃ“N**
- **MigraciÃ³n completada**: 80+ archivos actualizados
- **Puertos organizados**: 1111, 2222, 3333 (fÃ¡ciles de recordar)
- **DocumentaciÃ³n completa**: GuÃ­as y scripts disponibles
- **Zero regresiones**: Funcionalidad mantenida 100%

### **ğŸ”’ REGLAS CRÃTICAS**
1. **NUNCA usar puertos obsoletos** (3002, 3001, 3000)
2. **SIEMPRE verificar puertos** antes de desarrollo
3. **USAR scripts de verificaciÃ³n** disponibles
4. **MANTENER configuraciÃ³n actualizada** en .env files

**ğŸš€ Â¡El ecosistema CoomÃœnity estÃ¡ optimizado y listo para desarrollo eficiente!**