import { test, expect } from '@playwright/test';

test.describe('Gamifier Admin - Navegaci√≥n con Drawer', () => {
  test.beforeEach(async ({ page }) => {
    // Capturar errores de consola
    page.on('console', (msg) => {
      if (msg.type() === 'error') {
        console.log(`üî¥ Console error: ${msg.text()}`);
      }
    });

    // Flujo de autenticaci√≥n
    await page.goto('/login');
    await page.fill('input[name="email"]', 'admin@gamifier.com');
    await page.fill('input[name="password"]', 'admin123');
    await page.click('button[type="submit"]');
    await page.waitForURL('**/');
    
    // Verificar login exitoso
    await expect(page.getByRole('heading', { name: 'Welcome to Gamifier Admin' })).toBeVisible();
  });

  test('üöÄ Navegaci√≥n completa a trav√©s del Drawer/Men√∫ Lateral', async ({ page }) => {
    console.log('\nüéØ Iniciando navegaci√≥n completa del Gamifier Admin...\n');
    
    // Esperar a que todo cargue
    await page.waitForTimeout(3000);
    
    // ========================================
    // 1. BUSCAR Y ABRIR EL DRAWER/MEN√ö LATERAL
    // ========================================
    console.log('üîç PASO 1: Buscando el bot√≥n para abrir el men√∫ lateral...');
    
    // Posibles selectores para el bot√≥n del men√∫
    const menuButtonSelectors = [
      'button[aria-label*="menu"]',
      'button[aria-label*="Menu"]',
      'button[aria-label*="navigation"]',
      'button[aria-label*="drawer"]',
      'button[aria-label*="toggle"]',
      '[data-testid="menu-button"]',
      '[data-testid="drawer-toggle"]',
      '.menu-button',
      '.drawer-toggle',
      'button:has(svg)',  // Botones con iconos
      'button[aria-expanded]',
      'button[class*="menu"]',
      'button[class*="burger"]',
      'button[class*="hamburger"]'
    ];
    
    let menuButton = null;
    for (const selector of menuButtonSelectors) {
      const element = page.locator(selector);
      if (await element.isVisible()) {
        console.log(`‚úÖ Encontrado bot√≥n de men√∫: ${selector}`);
        menuButton = element;
        break;
      }
    }
    
    // Si no encontramos un bot√≥n espec√≠fico, buscar botones con iconos hamburguesa
    if (!menuButton) {
      console.log('üîç Buscando botones con iconos...');
      const iconButtons = page.locator('button').filter({ has: page.locator('svg') });
      const iconButtonCount = await iconButtons.count();
      
      for (let i = 0; i < iconButtonCount; i++) {
        const button = iconButtons.nth(i);
        if (await button.isVisible()) {
          const ariaLabel = await button.getAttribute('aria-label');
          console.log(`   üîò Bot√≥n con icono ${i + 1}: aria-label="${ariaLabel}"`);
          
          // Intentar hacer clic si parece ser un bot√≥n de men√∫
          if (!menuButton && (
            ariaLabel?.toLowerCase().includes('menu') ||
            ariaLabel?.toLowerCase().includes('navigation') ||
            ariaLabel?.toLowerCase().includes('drawer') ||
            ariaLabel?.toLowerCase().includes('sidebar')
          )) {
            menuButton = button;
            console.log(`‚úÖ Seleccionado como bot√≥n de men√∫`);
            break;
          }
        }
      }
    }
    
    // ========================================
    // 2. ABRIR EL MEN√ö/DRAWER
    // ========================================
    if (menuButton) {
      console.log('\nüìÇ PASO 2: Abriendo el men√∫ lateral...');
      await menuButton.click();
      await page.waitForTimeout(1500);
      
      // Verificar si el drawer se abri√≥
      const drawerSelectors = [
        '.MuiDrawer-root',
        '[role="navigation"]',
        '.drawer',
        '.sidebar',
        '[class*="drawer"]',
        '[class*="sidebar"]',
        '[class*="menu"]'
      ];
      
      let drawer = null;
      for (const selector of drawerSelectors) {
        const element = page.locator(selector);
        if (await element.isVisible()) {
          console.log(`‚úÖ Drawer encontrado: ${selector}`);
          drawer = element;
          break;
        }
      }
      
      if (drawer) {
        // ========================================
        // 3. EXPLORAR OPCIONES DEL MEN√ö
        // ========================================
        console.log('\nüìã PASO 3: Explorando opciones del men√∫...');
        
        const menuItems = drawer.locator('a, button, [role="menuitem"], li');
        const itemCount = await menuItems.count();
        console.log(`üîç Items de men√∫ encontrados: ${itemCount}`);
        
        const menuOptions = [];
        for (let i = 0; i < itemCount; i++) {
          const item = menuItems.nth(i);
          if (await item.isVisible()) {
            const itemText = await item.textContent();
            const href = await item.getAttribute('href');
            const role = await item.getAttribute('role');
            
            if (itemText?.trim()) {
              menuOptions.push({
                index: i,
                text: itemText.trim(),
                href: href,
                role: role,
                element: item
              });
              console.log(`   üìÑ ${i + 1}. "${itemText.trim()}" ${href ? `(${href})` : ''}`);
            }
          }
        }
        
        // ========================================
        // 4. NAVEGAR A CADA P√ÅGINA DISPONIBLE
        // ========================================
        console.log('\nüéØ PASO 4: Navegando a cada p√°gina disponible...');
        
        for (const option of menuOptions) {
          console.log(`\nüìç Navegando a: ${option.text}`);
          
          try {
            // Abrir el men√∫ si est√° cerrado
            if (menuButton && !(await drawer.isVisible())) {
              await menuButton.click();
              await page.waitForTimeout(500);
            }
            
            // Hacer clic en la opci√≥n
            await option.element.click();
            await page.waitForTimeout(2000);
            
            // Verificar navegaci√≥n
            const currentURL = page.url();
            console.log(`   üìç URL actual: ${currentURL}`);
            
            // Buscar t√≠tulo de la p√°gina
            const pageTitle = page.locator('h1, h2, [role="heading"]').first();
            if (await pageTitle.isVisible()) {
              const titleText = await pageTitle.textContent();
              console.log(`   üìã T√≠tulo: "${titleText?.trim()}"`);
            }
            
            // Verificar si hay contenido espec√≠fico
            if (currentURL.includes('/users')) {
              console.log('   üë• Verificando p√°gina de usuarios...');
              const usersTable = page.locator('table, .data-table');
              if (await usersTable.isVisible()) {
                console.log('   ‚úÖ Tabla de usuarios encontrada');
              }
            } else if (currentURL.includes('/roles')) {
              console.log('   üîê Verificando p√°gina de roles...');
              const rolesTable = page.locator('table, .data-table');
              if (await rolesTable.isVisible()) {
                console.log('   ‚úÖ Tabla de roles encontrada');
              }
            } else if (currentURL.includes('/mundos')) {
              console.log('   üåç Verificando p√°gina de mundos...');
              const mundosCards = page.locator('.mundo-card, [data-testid*="mundo"]');
              const mundoCount = await mundosCards.count();
              console.log(`   üìä Mundos encontrados: ${mundoCount}`);
            } else if (currentURL.includes('/playlists')) {
              console.log('   üìã Verificando p√°gina de playlists...');
              const playlistsCards = page.locator('.playlist-card, [data-testid*="playlist"]');
              const playlistCount = await playlistsCards.count();
              console.log(`   üìä Playlists encontradas: ${playlistCount}`);
            } else if (currentURL.includes('/permissions')) {
              console.log('   üîë Verificando p√°gina de permisos...');
              const permissionsTable = page.locator('table, .data-table');
              if (await permissionsTable.isVisible()) {
                console.log('   ‚úÖ Tabla de permisos encontrada');
              }
            } else if (currentURL.includes('/items')) {
              console.log('   üìπ Verificando p√°gina de contenido...');
              const itemsTable = page.locator('table, .data-table');
              if (await itemsTable.isVisible()) {
                console.log('   ‚úÖ Tabla de contenido encontrada');
              }
            } else if (currentURL.includes('/config') || currentURL.includes('/video')) {
              console.log('   ‚öôÔ∏è Verificando p√°gina de configuraci√≥n...');
              const configTabs = page.locator('[role="tab"]');
              const tabCount = await configTabs.count();
              console.log(`   üìä Tabs de configuraci√≥n: ${tabCount}`);
              
              // Verificar tab de subt√≠tulos
              const subtitleTab = page.getByRole('tab', { name: /subtitle/i });
              if (await subtitleTab.isVisible()) {
                console.log('   ‚úÖ Tab de subt√≠tulos encontrado');
                await subtitleTab.click();
                await page.waitForTimeout(1000);
                
                // Buscar bot√≥n de gesti√≥n
                const manageBtn = page.getByRole('button', { name: /manage|gestionar/i });
                if (await manageBtn.isVisible()) {
                  console.log('   ‚úÖ Bot√≥n de gesti√≥n de subt√≠tulos encontrado');
                  await manageBtn.click();
                  await page.waitForTimeout(2000);
                  
                  // Verificar modal
                  const modal = page.locator('[role="dialog"], .modal');
                  if (await modal.isVisible()) {
                    console.log('   ‚úÖ Modal de gesti√≥n abierto');
                    await page.keyboard.press('Escape');
                    await page.waitForTimeout(500);
                  }
                }
              }
              
              // Verificar tab de preguntas
              const questionTab = page.getByRole('tab', { name: /question/i });
              if (await questionTab.isVisible()) {
                console.log('   ‚úÖ Tab de preguntas encontrado');
                await questionTab.click();
                await page.waitForTimeout(1000);
              }
            }
            
            console.log(`   ‚úÖ Navegaci√≥n a "${option.text}" completada`);
            
            // Pausa para observaci√≥n
            await page.waitForTimeout(2000);
            
          } catch (error) {
            console.log(`   ‚ùå Error navegando a "${option.text}": ${error}`);
          }
        }
        
        // ========================================
        // 5. RESUMEN FINAL
        // ========================================
        console.log('\n‚úÖ NAVEGACI√ìN COMPLETADA');
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log('üìä P√°ginas navegadas:');
        menuOptions.forEach((option, index) => {
          console.log(`   ${index + 1}. ${option.text} ${option.href ? `(${option.href})` : ''}`);
        });
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        
      } else {
        console.log('‚ùå No se pudo encontrar el drawer despu√©s de hacer clic');
      }
      
    } else {
      console.log('‚ùå No se encontr√≥ bot√≥n para abrir el men√∫');
    }
    
    // Pausa final para observaci√≥n
    await page.waitForTimeout(5000);
  });
}); 