const { chromium } = require('playwright');

async function testVideoPermissionsFunctionality() {
  console.log('üéØ Iniciando test de funcionalidad de Permisos de Video...\n');
  
  const browser = await chromium.launch({ 
    headless: false,
    slowMo: 1000 
  });
  
  const context = await browser.newContext();
  const page = await context.newPage();

  try {
    // 1. LOGIN
    console.log('üîê Paso 1: Realizando login...');
    await page.goto('http://localhost:3000/login');
    await page.waitForLoadState('networkidle');

    await page.fill('input[name="email"]', 'admin@gamifier.com');
    await page.fill('input[name="password"]', 'admin123');
    await page.click('button[type="submit"]');
    await page.waitForURL('**/');

    // Verificar login exitoso
    try {
      await page.waitForSelector('nav, [role="navigation"], button[aria-label*="menu"]', { timeout: 5000 });
      console.log('‚úÖ Login exitoso');
    } catch {
      const currentUrl = page.url();
      if (!currentUrl.includes('/login')) {
        console.log('‚úÖ Login exitoso - Verificado por URL');
      } else {
        throw new Error('Login fall√≥');
      }
    }

    // 2. NAVEGACI√ìN A CONFIGURACI√ìN DE VIDEO
    console.log('\nüìπ Paso 2: Navegando a configuraci√≥n de video...');
    
    // Navegar directamente a la configuraci√≥n de un video espec√≠fico
    const videoId = '35'; // Usar un video que sabemos que existe
    await page.goto(`http://localhost:3000/items/${videoId}/config`);
    await page.waitForLoadState('networkidle');
    await page.waitForTimeout(3000);

    console.log('‚úÖ P√°gina de configuraci√≥n de video cargada');

    // 3. VERIFICAR PESTA√ëAS DISPONIBLES
    console.log('\nüîç Paso 3: Verificando pesta√±as disponibles...');
    
    const tabs = [
      'Configuraci√≥n',
      'Subt√≠tulos', 
      'Preguntas',
      'Permisos'
    ];

    for (const tabName of tabs) {
      try {
        const tab = page.getByRole('tab', { name: new RegExp(tabName, 'i') });
        await expect(tab).toBeVisible({ timeout: 5000 });
        console.log(`‚úÖ Pesta√±a "${tabName}" encontrada`);
      } catch (error) {
        console.log(`‚ùå Pesta√±a "${tabName}" no encontrada`);
      }
    }

    // 4. NAVEGAR A PESTA√ëA DE PERMISOS
    console.log('\nüîê Paso 4: Navegando a pesta√±a de Permisos...');
    
    const permissionsTab = page.getByRole('tab', { name: /Permisos/i });
    await permissionsTab.click();
    await page.waitForTimeout(2000);

    // Verificar que la pesta√±a est√° seleccionada
    await expect(permissionsTab).toHaveAttribute('aria-selected', 'true');
    console.log('‚úÖ Pesta√±a de Permisos seleccionada');

    // 5. VERIFICAR SECCIONES DE PERMISOS
    console.log('\nüìã Paso 5: Verificando secciones de permisos...');
    
    const permissionSections = [
      'Derechos de visualizaci√≥n del jugador',
      'Posici√≥n del video en la playlist'
    ];

    for (const section of permissionSections) {
      try {
        await page.waitForSelector(`text=${section}`, { timeout: 5000 });
        console.log(`‚úÖ Secci√≥n "${section}" encontrada`);
      } catch (error) {
        console.log(`‚ùå Secci√≥n "${section}" no encontrada`);
      }
    }

    // 6. VERIFICAR SWITCHES DE PERMISOS
    console.log('\nüéõÔ∏è Paso 6: Verificando switches de permisos...');
    
    const permissionSwitches = [
      'Visibilidad del n√∫mero de √ñndas',
      'Subt√≠tulos de video',
      'Fecha de publicaci√≥n'
    ];

    for (const switchName of permissionSwitches) {
      try {
        const switchElement = page.getByLabelText(switchName);
        await expect(switchElement).toBeVisible({ timeout: 5000 });
        console.log(`‚úÖ Switch "${switchName}" encontrado`);
        
        // Verificar que el switch es interactivo
        const isChecked = await switchElement.isChecked();
        console.log(`   Estado inicial: ${isChecked ? 'Activado' : 'Desactivado'}`);
      } catch (error) {
        console.log(`‚ùå Switch "${switchName}" no encontrado`);
      }
    }

    // 7. PROBAR INTERACCI√ìN CON SWITCHES
    console.log('\nüîÑ Paso 7: Probando interacci√≥n con switches...');
    
    try {
      const waveSwitch = page.getByLabelText('Visibilidad del n√∫mero de √ñndas');
      const initialState = await waveSwitch.isChecked();
      
      await waveSwitch.click();
      await page.waitForTimeout(500);
      
      const newState = await waveSwitch.isChecked();
      if (newState !== initialState) {
        console.log('‚úÖ Switch de √ñndas funciona correctamente');
      } else {
        console.log('‚ùå Switch de √ñndas no cambi√≥ de estado');
      }
    } catch (error) {
      console.log('‚ùå Error al probar switch de √ñndas:', error.message);
    }

    // 8. VERIFICAR SECCIONES EXPANDIBLES (ACCORDIONS)
    console.log('\nüìÇ Paso 8: Verificando secciones expandibles...');
    
    try {
      // Buscar y expandir secci√≥n de Videos
      const videosAccordion = page.locator('text=Videos').locator('..').locator('button').first();
      await videosAccordion.click();
      await page.waitForTimeout(1000);
      
      // Verificar que se expandi√≥
      const videoDurationSwitch = page.getByLabelText(/Duraci√≥n de.*videos/i);
      await expect(videoDurationSwitch).toBeVisible({ timeout: 3000 });
      console.log('‚úÖ Secci√≥n de Videos se expandi√≥ correctamente');
      
      // Probar switch dentro del accordion
      await videoDurationSwitch.click();
      console.log('‚úÖ Switch de duraci√≥n de videos funciona');
      
    } catch (error) {
      console.log('‚ùå Error con secci√≥n de Videos:', error.message);
    }

    try {
      // Buscar y expandir secci√≥n de Comentarios
      const commentsAccordion = page.locator('text=Comentarios').locator('..').locator('button').first();
      await commentsAccordion.click();
      await page.waitForTimeout(1000);
      
      // Verificar que se expandi√≥
      const viewCommentsSwitch = page.getByLabelText('Ver comentarios');
      await expect(viewCommentsSwitch).toBeVisible({ timeout: 3000 });
      console.log('‚úÖ Secci√≥n de Comentarios se expandi√≥ correctamente');
      
    } catch (error) {
      console.log('‚ùå Error con secci√≥n de Comentarios:', error.message);
    }

    // 9. VERIFICAR BOTONES DE POSICI√ìN
    console.log('\nüìç Paso 9: Verificando botones de posici√≥n...');
    
    const positions = ['Posici√≥n 1', 'Posici√≥n 2', 'Posici√≥n 3', 'Posici√≥n final'];
    
    for (const position of positions) {
      try {
        const positionButton = page.getByRole('button', { name: position });
        await expect(positionButton).toBeVisible({ timeout: 3000 });
        console.log(`‚úÖ Bot√≥n "${position}" encontrado`);
        
        // Probar click en el bot√≥n
        await positionButton.click();
        await page.waitForTimeout(500);
        console.log(`‚úÖ Bot√≥n "${position}" clickeable`);
        
      } catch (error) {
        console.log(`‚ùå Bot√≥n "${position}" no encontrado`);
      }
    }

    // 10. VERIFICAR BOTONES DE ACCI√ìN
    console.log('\nüíæ Paso 10: Verificando botones de acci√≥n...');
    
    const actionButtons = [
      'Guardar en borradores',
      'Publicar video'
    ];

    for (const buttonName of actionButtons) {
      try {
        const button = page.getByRole('button', { name: buttonName });
        await expect(button).toBeVisible({ timeout: 3000 });
        console.log(`‚úÖ Bot√≥n "${buttonName}" encontrado`);
        
        // Verificar que no est√° deshabilitado
        const isDisabled = await button.isDisabled();
        if (!isDisabled) {
          console.log(`‚úÖ Bot√≥n "${buttonName}" est√° habilitado`);
        } else {
          console.log(`‚ö†Ô∏è Bot√≥n "${buttonName}" est√° deshabilitado`);
        }
        
      } catch (error) {
        console.log(`‚ùå Bot√≥n "${buttonName}" no encontrado`);
      }
    }

    // 11. PROBAR FUNCIONALIDAD DE GUARDAR EN BORRADORES
    console.log('\nüíæ Paso 11: Probando funcionalidad de guardar en borradores...');
    
    try {
      const draftButton = page.getByRole('button', { name: 'Guardar en borradores' });
      await draftButton.click();
      await page.waitForTimeout(1000);
      
      // Verificar que se abre el dialog
      const dialogTitle = page.getByText('Guardar en borradores');
      await expect(dialogTitle).toBeVisible({ timeout: 3000 });
      console.log('‚úÖ Dialog de borradores se abri√≥');
      
      // Verificar selector de playlist
      const playlistSelector = page.getByLabelText('Seleccionar playlist');
      await expect(playlistSelector).toBeVisible({ timeout: 3000 });
      console.log('‚úÖ Selector de playlist encontrado');
      
      // Cerrar dialog
      const cancelButton = page.getByRole('button', { name: 'Cancelar' });
      await cancelButton.click();
      await page.waitForTimeout(500);
      console.log('‚úÖ Dialog cerrado correctamente');
      
    } catch (error) {
      console.log('‚ùå Error con funcionalidad de borradores:', error.message);
    }

    // 12. VERIFICAR MENSAJE DE ESTADO
    console.log('\nüì¢ Paso 12: Verificando mensajes de estado...');
    
    try {
      await page.waitForSelector('text=Se guardaron los cambios', { timeout: 3000 });
      console.log('‚úÖ Mensaje de estado encontrado');
      
      await page.waitForSelector('text=Carpeta 2024', { timeout: 3000 });
      console.log('‚úÖ Informaci√≥n de ubicaci√≥n encontrada');
      
    } catch (error) {
      console.log('‚ùå Mensajes de estado no encontrados:', error.message);
    }

    // Tomar screenshot final
    await page.screenshot({ 
      path: `debug-video-permissions-final-${Date.now()}.png`,
      fullPage: true 
    });

    console.log('\nüéâ Test de funcionalidad de Permisos completado exitosamente');

  } catch (error) {
    console.error('‚ùå Error durante el test:', error);
    
    // Capturar screenshot en caso de error
    await page.screenshot({ 
      path: `debug-video-permissions-error-${Date.now()}.png`,
      fullPage: true 
    });
    
    // Capturar informaci√≥n adicional de debug
    const currentUrl = page.url();
    console.log('URL actual:', currentUrl);
    
    const pageTitle = await page.title();
    console.log('T√≠tulo de p√°gina:', pageTitle);
    
  } finally {
    await browser.close();
  }
}

// Funci√≥n auxiliar para expect (simulada para este contexto)
function expect(locator) {
  return {
    toBeVisible: async (options = {}) => {
      try {
        await locator.waitFor({ state: 'visible', ...options });
        return true;
      } catch (error) {
        throw new Error(`Element not visible: ${error.message}`);
      }
    },
    toHaveAttribute: async (attribute, value) => {
      try {
        const actualValue = await locator.getAttribute(attribute);
        if (actualValue === value) {
          return true;
        } else {
          throw new Error(`Expected attribute ${attribute} to be ${value}, but got ${actualValue}`);
        }
      } catch (error) {
        throw new Error(`Attribute check failed: ${error.message}`);
      }
    }
  };
}

testVideoPermissionsFunctionality().catch(console.error); 