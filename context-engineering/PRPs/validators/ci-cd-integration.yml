# ğŸŒŒ GUARDIÃN DEL UMBRAL - CI/CD PHILOSOPHY VALIDATION
# Este pipeline actÃºa como el guardiÃ¡n automÃ¡tico que valida la alineaciÃ³n filosÃ³fica
# de cada Pull Request antes de permitir su fusiÃ³n con la rama principal.

name: ğŸ”® Cosmic Philosophy Validation

on:
  pull_request:
    branches: [main, godsplan, development]
    paths:
      - 'backend/src/**'
      - 'Demo/apps/superapp-unified/src/**'
      - 'apps/admin-frontend/src/**'
      - 'context-engineering/**'

jobs:
  philosophy-validation:
    name: ğŸ§™â€â™‚ï¸ SAGE Philosophy Validation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci --legacy-peer-deps

      - name: ğŸ”® Execute Philosophy Validation
        run: |
          echo "ğŸŒŒ Activating SAGE Validator..."
          npx tsx context-engineering/PRPs/validators/philosophy/PhilosophyValidator.ts

      - name: ğŸ“Š Cosmic Metrics Analysis
        run: |
          echo "ğŸ“ˆ Analyzing Cosmic Metrics..."
          npx tsx context-engineering/PRPs/validators/quality/CosmicMetrics.ts --pr-mode

      - name: ğŸ¯ Technical Quality Gate
        run: |
          echo "ğŸ”§ Executing Technical Validation..."
          npm run lint
          npm run type-check

      - name: ğŸ§ª Philosophical Alignment Test
        run: |
          echo "ğŸ§¬ Testing Philosophical Alignment..."
          npm run test:philosophy

      - name: ğŸ“ Generate Validation Report
        if: always()
        run: |
          echo "ğŸ“‹ Generating Cosmic Validation Report..."
          npx tsx context-engineering/PRPs/validators/generate-report.ts

      - name: ğŸ’ Cosmic Approval Gate
        run: |
          echo "âœ¨ Validating Cosmic Approval..."
          if [ -f "cosmic-validation-passed.flag" ]; then
            echo "ğŸŒŸ COSMIC VALIDATION PASSED - Ready for Merge"
            echo "ğŸ­ Philosophy Score: $(cat philosophy-score.txt)"
            echo "ğŸ“Š Quality Score: $(cat quality-score.txt)"
            echo "ğŸš€ Integration Score: $(cat integration-score.txt)"
          else
            echo "âŒ COSMIC VALIDATION FAILED - Review Required"
            echo "ğŸ“‹ See validation report for details"
            exit 1
          fi

      - name: ğŸ“¤ Upload Validation Artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: cosmic-validation-report
          path: |
            cosmic-validation-report.md
            philosophy-score.txt
            quality-score.txt
            integration-score.txt

  cosmic-metrics-dashboard:
    name: ğŸ“Š Update Cosmic Metrics Dashboard
    needs: philosophy-validation
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“Š Update Cosmic Dashboard
        run: |
          echo "ğŸŒŒ Updating Cosmic Metrics Dashboard..."
          npx tsx context-engineering/PRPs/validators/update-dashboard.ts

      - name: ğŸ¯ Deploy Metrics to Admin Panel
        run: |
          echo "ğŸš€ Deploying metrics to Gamifier Admin..."
          # AquÃ­ se integrarÃ­a con el deployment del Admin Panel

# ğŸŒŸ CONFIGURACIÃ“N DE PROTECCIÃ“N DE RAMAS
# Esta configuraciÃ³n debe aplicarse en GitHub Settings > Branches
# para que el GuardiÃ¡n del Umbral sea efectivo:
#
# Branch Protection Rules:
# âœ… Require status checks to pass before merging
# âœ… Require "ğŸ§™â€â™‚ï¸ SAGE Philosophy Validation" check
# âœ… Require "ğŸ“Š Update Cosmic Metrics Dashboard" check
# âœ… Require up-to-date branches before merging
# âœ… Include administrators in restrictions
#
# ğŸ”® El GuardiÃ¡n del Umbral ahora protege la pureza del cÃ³digo
# ğŸŒŒ Solo el cÃ³digo alineado con la FilosofÃ­a CoomÃœnity puede pasar
